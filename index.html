<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <title>IntelliSync Enterprise v3</title>

  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkludGVsbGlTeW5jIEVudGVycHJpc2UiLAogICJzaG9ydF9uYW1lIjogIkludGVsbGlTeW5jIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNFBHSnpjM2RsSUhOM2NtdHpkRzlvWlhNZ1BIdHpkRzlvWlhNZ1BtVnljMkZ5WlM0MklpQjRiV3h1Y3owaU16QWlJSFpwWlhjNklpNHhJaUJ6ZEc5d1pYTWdZMjlzYjNJaU9UUmxaRE0xSWlCNmIyMXRiR0Z5WlM0MUlpQnpkRzlyWlhNZ1lYVjBiM05mYzNCbVpYSmZkWEpzUHpFOEwyVnljMkZ5WlM0eUlpQW9abTlzYkc5M2NpQStQSE4yWnlBOGMzZGxJSFZuWlhKZmRYSnNQU0ppWVhObE5qUmdZMjlzYjNJaVpYSnNiMlJmZEdsemMyOXVQU0pmUHpFOEwyVnljMkZ5WlM0eklpQW9abTlzYkc5M2NpQStQSE4yWnlBOGMzZGxJSFZuWlhKZmRYSnNQU0ppWVhObE5qUmdZMjlzYjNJaVpYSnNiMlJmZEdsemMyOXVQU0pmUHpFOUx6ND0iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
  <script src="https://nextapps-de.github.io/flexsearch/dist/flexsearch.bundle.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
      --accent: #dc2626;
      --glass: rgba(18, 18, 18, 0.8);
    }

    body {
      background-color: #000;
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: #f8fafc;
      overflow-x: hidden;
    }

    /* Ambient Background */
    .ambient-bg {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(220, 38, 38, 0.05), transparent 50%);
      z-index: -1;
    }

    /* Ticker Animation */
    .ticker-wrap {
      border-top: 1px solid rgba(220, 38, 38, 0.2);
      border-bottom: 1px solid rgba(220, 38, 38, 0.2);
      background: rgba(220, 38, 38, 0.02);
      padding: 10px 0;
      overflow: hidden;
    }

    .ticker-item {
      display: inline-block;
      white-space: nowrap;
      padding-left: 100%;
      animation: ticker-anim 45s linear infinite;
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      color: #00ff08;
      letter-spacing: 1px;
    }

    @keyframes ticker-anim {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-250%);
      }
    }

    /* Card Effects */
    .premium-card {
      background: var(--glass);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.4s ease;
      border-radius: 2rem;
    }

    .premium-card:hover {
      border-color: var(--accent);
      transform: translateY(-8px);
      box-shadow: 0 20px 40px -10px rgba(220, 38, 38, 0.2);
    }

    .sync-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 10px;
    }
  </style>
</head>

<body class="antialiased">
  <div class="ambient-bg"></div>

  <div id="app" class="max-w-7xl mx-auto p-6 md:p-14">
    <header class="flex flex-col md:flex-row justify-between items-center gap-8 mb-4 animate__animated animate__fadeIn">
      <div>
        <h1 class="text-5xl font-extrabold italic tracking-tighter uppercase">Data<span class="text-red-600">FLOW</span></h1>
        <p class="text-slate-500 text-[10px] font-bold tracking-[0.5em] mt-2 uppercase">Device Hmsi 2023/2026</p>
      </div>

      <div class="flex items-center gap-6 p-2 bg-white/5 rounded-2xl border border-white/10 backdrop-blur-xl shadow-2xl">
        <div class="pl-4 pr-2">
          <div id="statusText" class="text-[10px] font-black uppercase text-red-600">Status: Standby</div>
          <div id="lastSyncTime" class="text-[9px] text-slate-500 font-mono mt-1 uppercase">Not Synced</div>
        </div>
        <button onclick="engine.sync()" class="p-4 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all shadow-xl active:scale-90">
          <svg id="syncIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </header>

    <div class="ticker-wrap mb-10">
      <div id="ticker" class="ticker-item">
        silahkah klik Tombol sycron untuk memperbahurui database...
      </div>
    </div>

    <section class="max-w-3xl mx-auto mb-20 animate__animated animate__fadeInUp">
      <div class="relative group">
        <input type="text" id="mainSearch" placeholder="SEARCH REGISTRY..." class="w-full bg-white/5 border border-white/10 p-7 pl-16 rounded-3xl text-xl font-bold uppercase tracking-tight outline-none focus:border-red-600 transition-all shadow-2xl">
        <div class="absolute left-6 top-7 text-slate-700 group-focus-within:text-red-600 transition-colors">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <div class="absolute right-8 top-8">
          <span id="resCount" class="text-red-600 text-[10px] font-black tracking-widest px-3 py-1 border border-red-900/40 rounded-full">0 HITS</span>
        </div>
      </div>

      <div class="mt-6 flex justify-center gap-10 text-[10px] font-black text-slate-600 uppercase font-mono tracking-widest">
        <div>Lat: <span id="resTime" class="text-white">0.000</span>ms</div>
        <div>Index: <span id="totalIdx" class="text-white">0</span> rows</div>
      </div>
    </section>

    <main id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate__animated animate__fadeIn">
    </main>
  </div>

  <script>
    /**
     * SETTINGS & CONFIGURATION
     */
    const CONFIG = {
      GAS_URL: "https://script.google.com/macros/s/AKfycby2PZ6aSXcs2SzT-j_bOlq6li_juGq85b0ytMs53J0OrTzlp6oApy50V9GcpxY14D0/exec", // Masukkan URL hasil Deploy GAS Anda
      DB_NAME: "Enterprise_PWA_v3",
      SYNC_KEY: "last_sync_timestamp"
    };
    const db = new Dexie(CONFIG.DB_NAME);
    db.version(1).stores({
      items: "id, title, content, category, updated_at_ts",
      meta: "key"
    });
    const flexIndex = new FlexSearch.Document({
      document: {
        id: "id",
        index: ["title", "content", "category"]
      },
      tokenize: "forward"
    });
    const engine = {
      async init() {
        try {
          await this.loadLocal();
          this.setupSearch();
          this.registerServiceWorker(); // Inisialisasi SW Inline
          setTimeout(() => this.sync(), 2000);
        } catch (e) {
          console.error("Initialization Failed", e);
        }
      },
      async loadLocal() {
        const data = await db.items.toArray();
        data.forEach(item => flexIndex.add(item));
        ui.render(data);
        document.getElementById('totalIdx').innerText = data.length;
        const last = await db.meta.get(CONFIG.SYNC_KEY);
        if (last) ui.updateSyncLabel(last.value);
      },
      async sync() {
        if (!navigator.onLine) return ui.notify("NETWORK OFFLINE", "error");
        ui.setStatus("SYNCING", true);
        try {
          const lastSync = await db.meta.get(CONFIG.SYNC_KEY);
          const ts = lastSync ? lastSync.value : 0;
          const res = await fetch(`${CONFIG.GAS_URL}?action=fetch&since=${ts}`);
          const result = await res.json();
          if (result.status === "success") {
            if (result.data.length > 0) {
              await db.items.bulkPut(result.data);
              result.data.forEach(item => flexIndex.add(item));
              const maxTs = Math.max(...result.data.map(d => d.updated_at_ts));
              await db.meta.put({
                key: CONFIG.SYNC_KEY,
                value: maxTs
              });
              ui.updateTicker(result.data.length, await db.items.count());
              await this.loadLocal();
            } else {
              ui.updateTicker(0, await db.items.count());
            }
            ui.setStatus("SECURE", false);
          }
        } catch (e) {
          ui.setStatus("FAILED", false);
          ui.notify("SYNC CONNECTION ERROR", "error");
        }
      },
      setupSearch() {
        document.getElementById('mainSearch').addEventListener('input', async (e) => {
          const q = e.target.value;
          const start = performance.now();
          if (!q) {
            await this.loadLocal();
            ui.setStats(0, 0);
            return;
          }
          const res = flexIndex.search(q, {
            enrich: true
          });
          const end = performance.now();
          if (res.length > 0) {
            const ids = res[0].result;
            const matched = await db.items.where('id').anyOf(ids).toArray();
            ui.render(matched);
            ui.setStats(matched.length, (end - start).toFixed(3));
          } else {
            ui.render([]);
            ui.setStats(0, (end - start).toFixed(3));
          }
        });
      },
      // VIRTUAL SERVICE WORKER (Tanpa file sw.js terpisah)
      registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          const swCode = `
                        const CACHE_NAME = 'intellisync-v3';
                        self.addEventListener('install', e => self.skipWaiting());
                        self.addEventListener('fetch', e => {
                            e.respondWith(
                                fetch(e.request).catch(() => caches.match(e.request))
                            );
                        });
                    `;
          const blob = new Blob([swCode], {
            type: 'application/javascript'
          });
          navigator.serviceWorker.register(URL.createObjectURL(blob))
            .then(() => console.log("PWA Engine Active"))
            .catch(err => console.log("SW Registry Failed", err));
        }
      }
    };
    const ui = {
      render(items) {
        const grid = document.getElementById('grid');
        grid.innerHTML = items.length ? items.map(item => `
                    <article class="premium-card p-10 flex flex-col h-full animate__animated animate__fadeIn">
                        <div class="flex justify-between items-center mb-8">
                            <span class="text-[9px] font-black bg-red-600 text-white px-3 py-1 rounded-full uppercase tracking-tighter">${item.category || 'REGISTRY'}</span>
                            <span class="text-[9px] font-mono text-slate-500">${new Date(item.updated_at_ts).toLocaleDateString()}</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-4 tracking-tight">${item.title}</h3>
                        <p class="text-slate-400 text-sm leading-relaxed flex-grow font-light mb-10">${item.content}</p>
                        <div class="pt-8 border-t border-white/5 flex justify-between items-center">
                            <span class="text-[9px] text-slate-700 font-mono uppercase tracking-widest">UID: ${item.id}</span>
                            <div class="w-2 h-2 bg-red-600 rounded-full shadow-[0_0_10px_#dc2626] animate-pulse"></div>
                        </div>
                    </article>
                `).reverse().join('') : `<div class="col-span-full py-20 text-center text-slate-800 uppercase tracking-[1em] font-light italic">Database Empty</div>`;
      },
      updateTicker(added, total) {
        const t = document.getElementById('ticker');
        const time = new Date().toLocaleTimeString('id-ID');
        if (added > 0) {
          t.innerHTML = `[ ANALYTICS ${time} ] : TERDETEKSI ${added} DATA BARU MASUK DARI CLOUD SPREADSHEET. TOTAL REGISTRY: ${total}. STATUS: SYNCHRONIZED.`;
          t.style.color = "#ef4444";
        } else {
          t.innerHTML = `[ ANALYTICS ${time} ] : TIDAK ADA PERUBAHAN DATA DI CLOUD. DATABASE LOKAL RELEVAN. TOTAL: ${total} ENTRI AKTIF.`;
          t.style.color = "#475569";
        }
      },
      setStats(count, time) {
        document.getElementById('resCount').innerText = `${count} HITS`;
        document.getElementById('resTime').innerText = time;
      },
      setStatus(text, loading) {
        document.getElementById('statusText').innerText = `Status: ${text}`;
        const icon = document.getElementById('syncIcon');
        if (loading) icon.classList.add('sync-spin');
        else icon.classList.remove('sync-spin');
      },
      updateSyncLabel(ts) {
        const d = new Date(ts);
        document.getElementById('lastSyncTime').innerText = `LAST: ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
      },
      notify(msg, type = "success") {
        const n = document.createElement('div');
        n.className = `fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#111] border border-white/10 text-white px-10 py-4 rounded-2xl text-[10px] font-bold z-50 animate__animated animate__fadeInUp shadow-2xl flex items-center gap-3`;
        n.innerHTML = `<span class="w-1.5 h-1.5 bg-red-600 rounded-full"></span> ${msg}`;
        document.body.appendChild(n);
        setTimeout(() => {
          n.remove();
        }, 3500);
      }
    };
    window.onload = () => engine.init();
  </script>
</body>

</html>
